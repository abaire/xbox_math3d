#include <boost/test/unit_test.hpp>

#include "xbox_math_matrix.h"

using namespace XboxMath;

BOOST_AUTO_TEST_SUITE(xbox_math_matrix_suite)

#define TOLERANCE 1e-5f

#define VECTOR_TEST(v, x, y, z, w)                                    \
  BOOST_TEST((v)[0] == (x), boost::test_tools::tolerance(TOLERANCE)); \
  BOOST_TEST((v)[1] == (y), boost::test_tools::tolerance(TOLERANCE)); \
  BOOST_TEST((v)[2] == (z), boost::test_tools::tolerance(TOLERANCE)); \
  BOOST_TEST((v)[3] == (w), boost::test_tools::tolerance(TOLERANCE))

#define MATRIX_TEST(m, m11, m12, m13, m14, m21, m22, m23, m24, m31, m32, m33, \
                    m34, m41, m42, m43, m44)                                  \
  VECTOR_TEST((m)[0], m11, m12, m13, m14);                                    \
  VECTOR_TEST((m)[1], m21, m22, m23, m24);                                    \
  VECTOR_TEST((m)[2], m31, m32, m33, m34);                                    \
  VECTOR_TEST((m)[3], m41, m42, m43, m44)

#define VECTOR3_TEST(v, x, y, z)                                      \
  BOOST_TEST((v)[0] == (x), boost::test_tools::tolerance(TOLERANCE)); \
  BOOST_TEST((v)[1] == (y), boost::test_tools::tolerance(TOLERANCE)); \
  BOOST_TEST((v)[2] == (z), boost::test_tools::tolerance(TOLERANCE))

#define MATRIX3_TEST(m, m11, m12, m13, m21, m22, m23, m31, m32, m33) \
  VECTOR3_TEST((m)[0], m11, m12, m13);                               \
  VECTOR3_TEST((m)[1], m21, m22, m23);                               \
  VECTOR3_TEST((m)[2], m31, m32, m33)

BOOST_AUTO_TEST_CASE(matrix_identity_produces_identity_matrix) {
  matrix4_t test;

  MatrixSetIdentity(test);

  MATRIX_TEST(test, 1.0f, 0.0f, 0.0f, 0.0f, 0.0f, 1.0f, 0.0f, 0.0f, 0.0f, 0.0f,
              1.0f, 0.0f, 0.0f, 0.0f, 0.0f, 1.0f);
}

BOOST_AUTO_TEST_CASE(matrix_add_matrix) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  matrix4_t mat2{
      0.8474566404344737f,   0.8195603850635462f,  0.8646734780714075f,
      0.9600013265199839f,   0.2608105073877024f,  0.5825968184915961f,
      0.027140487343348507f, 0.3557219290589344f,  0.6858570908919961f,
      0.42139371892600175f,  0.22105798117221032f, 0.8790446036260353f,
      0.4298333884494392f,   0.8817767666153977f,  0.881249550648736f,
      0.6270929678277427f};

  matrix4_t result;
  MatrixAddMatrix(mat1, mat2, result);

  MATRIX_TEST(result, 1.3024297704344736f, 1.6228529450635463f,
              1.3118180580714074f, 1.938294306519984f, 0.3636690373877024f,
              0.728749198491596f, 0.9603374873433486f, 0.7738138290589345f,
              0.8890885908919961f, 0.8591011589260018f, 0.8937328511722104f,
              1.0932643336260353f, 0.9021145684494392f, 0.9179105266153977f,
              1.497668770648736f, 0.8818682878277427f);
}

BOOST_AUTO_TEST_CASE(matrix_add_matrix_inline) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  matrix4_t mat2{
      0.8474566404344737f,   0.8195603850635462f,  0.8646734780714075f,
      0.9600013265199839f,   0.2608105073877024f,  0.5825968184915961f,
      0.027140487343348507f, 0.3557219290589344f,  0.6858570908919961f,
      0.42139371892600175f,  0.22105798117221032f, 0.8790446036260353f,
      0.4298333884494392f,   0.8817767666153977f,  0.881249550648736f,
      0.6270929678277427f};

  MatrixAddMatrix(mat1, mat2);

  MATRIX_TEST(mat1, 1.3024297704344736f, 1.6228529450635463f,
              1.3118180580714074f, 1.938294306519984f, 0.3636690373877024f,
              0.728749198491596f, 0.9603374873433486f, 0.7738138290589345f,
              0.8890885908919961f, 0.8591011589260018f, 0.8937328511722104f,
              1.0932643336260353f, 0.9021145684494392f, 0.9179105266153977f,
              1.497668770648736f, 0.8818682878277427f);
}

BOOST_AUTO_TEST_CASE(scalar_mult_matrix) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix4_t result;
  ScalarMultMatrix(mat1, 0.45f, result);

  MATRIX_TEST(result, 0.2047379085f, 0.36148165200000004f, 0.201215061f,
              0.440231841f, 0.0462863385f, 0.065768571f, 0.41993865f,
              0.188141355f, 0.09145417500000001f, 0.19696834800000002f,
              0.30270369150000004f, 0.09639887850000001f, 0.21252653100000002f,
              0.016260192f, 0.27738864900000004f, 0.11464889400000002f);
}

BOOST_AUTO_TEST_CASE(scalar_mult_matrix_inplace) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  ScalarMultMatrix(mat1, 0.45f);

  MATRIX_TEST(mat1, 0.2047379085f, 0.36148165200000004f, 0.201215061f,
              0.440231841f, 0.0462863385f, 0.065768571f, 0.41993865f,
              0.188141355f, 0.09145417500000001f, 0.19696834800000002f,
              0.30270369150000004f, 0.09639887850000001f, 0.21252653100000002f,
              0.016260192f, 0.27738864900000004f, 0.11464889400000002f);
}

BOOST_AUTO_TEST_CASE(matrix_mult_matrix) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  matrix4_t mat2{
      0.8474566404344737f,   0.8195603850635462f,  0.8646734780714075f,
      0.9600013265199839f,   0.2608105073877024f,  0.5825968184915961f,
      0.027140487343348507f, 0.3557219290589344f,  0.6858570908919961f,
      0.42139371892600175f,  0.22105798117221032f, 0.8790446036260353f,
      0.4298333884494392f,   0.8817767666153977f,  0.881249550648736f,
      0.6270929678277427f};

  matrix4_t result;
  MatrixMultMatrix(mat1, mat2, result);

  MATRIX_TEST(result, 1.3222574077287463f, 1.8919335815610834f,
              1.3761700774785295f, 1.7290642656957154f, 0.945035858366951f,
              0.9313537661075215f, 0.6676396335648419f, 1.2332382091597953f,
              0.8398262056072067f, 0.8939223943331316f, 0.5250896707441512f,
              1.0764515452321965f, 0.9419483185106581f, 0.8925245047714734f,
              0.7701347229895525f, 1.1678719305622087f);
}

BOOST_AUTO_TEST_CASE(matrix_mult_matrix_inline) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  matrix4_t mat2{
      0.8474566404344737f,   0.8195603850635462f,  0.8646734780714075f,
      0.9600013265199839f,   0.2608105073877024f,  0.5825968184915961f,
      0.027140487343348507f, 0.3557219290589344f,  0.6858570908919961f,
      0.42139371892600175f,  0.22105798117221032f, 0.8790446036260353f,
      0.4298333884494392f,   0.8817767666153977f,  0.881249550648736f,
      0.6270929678277427f};

  MatrixMultMatrix(mat1, mat2);

  MATRIX_TEST(mat1, 1.3222574077287463f, 1.8919335815610834f,
              1.3761700774785295f, 1.7290642656957154f, 0.945035858366951f,
              0.9313537661075215f, 0.6676396335648419f, 1.2332382091597953f,
              0.8398262056072067f, 0.8939223943331316f, 0.5250896707441512f,
              1.0764515452321965f, 0.9419483185106581f, 0.8925245047714734f,
              0.7701347229895525f, 1.1678719305622087f);
}

BOOST_AUTO_TEST_CASE(matrix_transpose) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix4_t result;
  MatrixTranspose(mat1, result);

  MATRIX_TEST(result, 0.45497313f, 0.10285853f, 0.2032315f, 0.47228118f,
              0.80329256f, 0.14615238f, 0.43770744f, 0.03613376f, 0.44714458f,
              0.933197f, 0.67267487f, 0.61641922f, 0.97829298f, 0.4180919f,
              0.21421973f, 0.25477532f);
}

BOOST_AUTO_TEST_CASE(matrix_transpose_inplace) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  MatrixTranspose(mat1);

  MATRIX_TEST(mat1, 0.45497313f, 0.10285853f, 0.2032315f, 0.47228118f,
              0.80329256f, 0.14615238f, 0.43770744f, 0.03613376f, 0.44714458f,
              0.933197f, 0.67267487f, 0.61641922f, 0.97829298f, 0.4180919f,
              0.21421973f, 0.25477532f);
}

BOOST_AUTO_TEST_CASE(matrix_determinant) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  float result;
  MatrixDeterminant(mat1, result);

  BOOST_TEST(result == 0.13013199761385197f);
}

BOOST_AUTO_TEST_CASE(matrix_determinant_inplace) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  float result = MatrixDeterminant(mat1);

  BOOST_TEST(result == 0.13013199761385197f);
}

BOOST_AUTO_TEST_CASE(matrix_cofactor_00) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix3_t result;
  MatrixCofactor(mat1, 0, 0, result);

  MATRIX3_TEST(result, 0.14615238f, 0.933197f, 0.4180919f, 0.43770744f,
               0.67267487f, 0.21421973f, 0.03613376f, 0.61641922f, 0.25477532f);
}

BOOST_AUTO_TEST_CASE(matrix_cofactor_23) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix3_t result;
  MatrixCofactor(mat1, 2, 3, result);

  MATRIX3_TEST(result, 0.45497313f, 0.80329256f, 0.44714458f, 0.10285853f,
               0.14615238f, 0.933197f, 0.47228118f, 0.03613376f, 0.61641922f);
}

BOOST_AUTO_TEST_CASE(matrix_determinant_3x3) {
  matrix3_t mat1{0.45497313f, 0.80329256f, 0.44714458f,
                 0.10285853f, 0.14615238f, 0.933197f,
                 0.2032315f,  0.43770744f, 0.67267487f};

  float result = MatrixDeterminant(mat1);

  BOOST_TEST(result == -0.0374935777011427f);
}

BOOST_AUTO_TEST_CASE(matrix_adjoint) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix4_t result;
  MatrixAdjoint(mat1, result);

  MATRIX_TEST(result, 0.011548182253112993f, -0.22536766927495697f,
              0.029215612696405956f, 0.30092526525783075f,
              0.030307972205033964f, -0.14825812283280443f,
              0.30164596991086323f, -0.12671193744555986f, -0.0654648185838749f,
              0.10815657095795653f, 0.08374205154482095f, 0.003474381022085934f,
              0.13268413233202908f, 0.17711387076165488f, -0.2995494116732589f,
              -0.0374935777011427f);
}

BOOST_AUTO_TEST_CASE(matrix_adjoint_inplace) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  MatrixAdjoint(mat1);

  MATRIX_TEST(mat1, 0.011548182253112993f, -0.22536766927495697f,
              0.029215612696405956f, 0.30092526525783075f,
              0.030307972205033964f, -0.14825812283280443f,
              0.30164596991086323f, -0.12671193744555986f, -0.0654648185838749f,
              0.10815657095795653f, 0.08374205154482095f, 0.003474381022085934f,
              0.13268413233202908f, 0.17711387076165488f, -0.2995494116732589f,
              -0.0374935777011427f);
}

BOOST_AUTO_TEST_CASE(matrix_invert) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};

  matrix4_t result;
  MatrixInvert(mat1, result);

  MATRIX_TEST(result, 0.08874206547862683f, -1.7318390050670178f,
              0.22450752491404213f, 2.312461737126201f, 0.2329017671346945f,
              -1.1392903017806513f, 2.3179999957116957f, -0.9737185301770234f,
              -0.5030647326119773f, 0.8311297216761063f, 0.643516222607398f,
              0.026698898701268486f, 1.019611892270725f, 1.3610324440512693f,
              -2.3018889832316933f, -0.2881195892527488f);
}

BOOST_AUTO_TEST_CASE(create_translation_matrix) {
  vector_t vec1{-0.75f, 0.124f, -0.99f, 1.f};

  matrix4_t result;
  CreateTranslationMatrix(vec1, result);

  MATRIX_TEST(result, 1.f, 0.f, 0.f, 0.f, 0.f, 1.f, 0.f, 0.f, 0.f, 0.f, 1.f,
              0.f, -0.75f, 0.123999998f, -0.99000001f, 1.f);
}

BOOST_AUTO_TEST_CASE(test_matrix_translate) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  vector_t vec1{-0.75f, 0.124f, -0.99f, 1.f};

  matrix4_t result;
  MatrixTranslate(mat1, vec1, result);

  MATRIX_TEST(result, -0.278746605f, 0.924600899f, -0.521365523f, 0.978293002f,
              -0.210710391f, 0.197995767f, 0.519286036f, 0.418091893f,
              0.042566698f, 0.464270711f, 0.460597366f, 0.214219734f,
              0.281199694f, 0.0677258968f, 0.364191622f, 0.254775316f);
}

BOOST_AUTO_TEST_CASE(create_scale_matrix) {
  vector_t vec1{-0.75f, 0.124f, -0.99f, 1.f};

  matrix4_t result;
  CreateScaleMatrix(vec1, result);

  MATRIX_TEST(result, -0.75f, 0.f, 0.f, 0.f, 0.f, 0.123999998f, 0.f, 0.f, 0.f,
              0.f, -0.99000001f, 0.f, 0.f, 1.40129846e-45f, 0.f, 1.f);
}

BOOST_AUTO_TEST_CASE(test_matrix_scale) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  vector_t vec1{-0.75f, 0.124f, -0.99f, 1.f};

  matrix4_t result;
  MatrixScale(mat1, vec1, result);

  MATRIX_TEST(result, -0.341229856f, 0.0996082798f, -0.442673117f, 0.978293002f,
              -0.0771438926f, 0.0181228947f, -0.92386508f, 0.418091893f,
              -0.15242362f, 0.054275725f, -0.665948153f, 0.214219734f,
              -0.354210883f, 0.00448058592f, -0.610255003f, 0.254775316f);
}

BOOST_AUTO_TEST_CASE(test_matrix_rotate) {
  matrix4_t mat1{0.45497313f, 0.80329256f, 0.44714458f, 0.97829298f,
                 0.10285853f, 0.14615238f, 0.933197f,   0.4180919f,
                 0.2032315f,  0.43770744f, 0.67267487f, 0.21421973f,
                 0.47228118f, 0.03613376f, 0.61641922f, 0.25477532f};
  vector_t vec1{M_PI * 0.5f, M_PI * 0.25f, M_PI, 0.0};

  matrix4_t result;
  MatrixRotate(mat1, vec1, result);

  MATRIX_TEST(result, -0.00553559931f, -0.637893438f, -0.803292632f,
              0.978293002f, 0.587137997f, -0.732601881f, -0.146152422f,
              0.418091893f, 0.331946641f, -0.619359314f, -0.437707514f,
              0.214219734f, 0.101920955f, -0.769827425f, -0.0361338332f,
              0.254775316f);
}

BOOST_AUTO_TEST_SUITE_END()
